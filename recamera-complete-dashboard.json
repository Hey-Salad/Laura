[
  {
    "id": "f7d5cf3810421cf3",
    "type": "subflow",
    "name": "Default Pages",
    "info": "",
    "category": "Vision AI",
    "in": [],
    "out": [],
    "env": [],
    "meta": {},
    "color": "#DDAA99"
  },
  {
    "id": "ai_integration_tab",
    "type": "tab",
    "label": "HeySalad AI Integration",
    "disabled": false,
    "info": "OpenAI Realtime + ElevenLabs + Gimbal Control"
  },
  {
    "id": "config_inject",
    "type": "inject",
    "z": "ai_integration_tab",
    "name": "Initialize AI Config",
    "props": [],
    "repeat": "",
    "crontab": "",
    "once": true,
    "onceDelay": 0.1,
    "x": 140,
    "y": 60,
    "wires": [["set_ai_config"]]
  },
  {
    "id": "set_ai_config",
    "type": "function",
    "z": "ai_integration_tab",
    "name": "Set AI Configuration",
    "func": "// Laura API Configuration\n// CAMERA_ID is used for OpenAI and ElevenLabs APIs\nflow.set('CAMERA_ID', 'recamera-gimbal-001');\n// CAMERA_UUID is used for gimbal commands (database UUID)\nflow.set('CAMERA_UUID', '34236c48-2dae-4fe6-9bae-27e640f84d71');\nflow.set('LAURA_API_URL', 'https://laura.heysalad.app');\n\n// Get OpenAI credentials from Laura\n// You'll need to make an HTTP request to get the WebSocket URL and key\nflow.set('OPENAI_MODEL', 'gpt-4o-realtime-preview-2024-10-01');\n\n// ElevenLabs configuration\nflow.set('ELEVENLABS_VOICE_ID', '21m00Tcm4TlvDq8ikWAM'); // Rachel voice\n\nnode.warn('ðŸ¤– AI configuration initialized');\nnode.status({ fill: 'green', shape: 'dot', text: 'AI Ready' });\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 370,
    "y": 60,
    "wires": [["get_openai_creds"]]
  },
  {
    "id": "get_openai_creds",
    "type": "function",
    "z": "ai_integration_tab",
    "name": "Get OpenAI Credentials",
    "func": "const cameraId = flow.get('CAMERA_ID');\nconst lauraUrl = flow.get('LAURA_API_URL');\n\nmsg.url = `${lauraUrl}/api/ai/openai-realtime`;\nmsg.method = 'POST';\nmsg.payload = { camera_id: cameraId };\n\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 630,
    "y": 60,
    "wires": [["http_get_creds"]]
  },
  {
    "id": "http_get_creds",
    "type": "http request",
    "z": "ai_integration_tab",
    "name": "HTTP Get Credentials",
    "method": "use",
    "ret": "obj",
    "paytoqs": "ignore",
    "url": "",
    "tls": "",
    "persist": false,
    "proxy": "",
    "authType": "",
    "senderr": false,
    "x": 870,
    "y": 60,
    "wires": [["store_creds"]]
  },
  {
    "id": "store_creds",
    "type": "function",
    "z": "ai_integration_tab",
    "name": "Store Credentials",
    "func": "const response = msg.payload;\n\nif (response.websocket_url) {\n    flow.set('OPENAI_WS_URL', response.websocket_url);\n    node.warn('âœ… Secure WebSocket proxy configured');\n    node.warn('ðŸ“ WebSocket URL (with token): ' + response.websocket_url);\n    node.warn('ðŸŽ¯ COPY THIS URL TO WEBSOCKET CLIENT CONFIG');\n} else {\n    node.warn('âš ï¸ Failed to configure secure proxy');\n    node.error('Response: ' + JSON.stringify(response));\n}\n\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 1100,
    "y": 60,
    "wires": [[]]
  },
  {
    "id": "camera_capture",
    "type": "camera",
    "z": "ai_integration_tab",
    "option": 0,
    "audio": true,
    "volume": 80,
    "name": "Camera + Audio Capture",
    "x": 180,
    "y": 180,
    "wires": [["ai_inference", "stream_output"]]
  },
  {
    "id": "ai_inference",
    "type": "model",
    "z": "ai_integration_tab",
    "name": "AI Object Detection",
    "uri": "",
    "model": "",
    "tscore": 0.45,
    "tiou": 0.25,
    "debug": false,
    "trace": false,
    "counting": false,
    "classes": "",
    "splitter": "0,0,0,0",
    "x": 420,
    "y": 180,
    "wires": [["process_detections"]]
  },
  {
    "id": "process_detections",
    "type": "function",
    "z": "ai_integration_tab",
    "name": "Process Detections",
    "func": "// Process AI detections and trigger actions\nconst detections = msg.payload;\n\nif (detections && detections.length > 0) {\n    node.warn(`ðŸŽ¯ Detected ${detections.length} object(s)`);\n    \n    // Send to OpenAI for analysis\n    msg.detected_objects = detections;\n    msg.action = 'analyze_scene';\n    \n    return msg;\n}\n\nreturn null;",
    "outputs": 1,
    "noerr": 0,
    "x": 660,
    "y": 180,
    "wires": [["send_to_openai"]]
  },
  {
    "id": "send_to_openai",
    "type": "function",
    "z": "ai_integration_tab",
    "name": "Format for OpenAI",
    "func": "// Format message for OpenAI Realtime API\nconst detections = msg.detected_objects || [];\nconst objectList = detections.map(d => d.class).join(', ');\n\nmsg.payload = {\n    type: 'conversation.item.create',\n    item: {\n        type: 'message',\n        role: 'user',\n        content: [{\n            type: 'input_text',\n            text: `I see the following objects in the kitchen: ${objectList}. What should I do?`\n        }]\n    }\n};\n\nnode.warn('ðŸ“¤ Sending to OpenAI:', msg.payload.item.content[0].text);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 900,
    "y": 180,
    "wires": [["openai_websocket_out"]]
  },
  {
    "id": "openai_websocket_out",
    "type": "websocket out",
    "z": "ai_integration_tab",
    "name": "OpenAI WebSocket Out",
    "server": "",
    "client": "openai_ws_client",
    "x": 180,
    "y": 280,
    "wires": []
  },
  {
    "id": "openai_websocket_in",
    "type": "websocket in",
    "z": "ai_integration_tab",
    "name": "OpenAI WebSocket In",
    "server": "",
    "client": "openai_ws_client",
    "x": 180,
    "y": 360,
    "wires": [["process_openai_response"]]
  },
  {
    "id": "process_openai_response",
    "type": "function",
    "z": "ai_integration_tab",
    "name": "Process OpenAI Response",
    "func": "const response = msg.payload;\n\nif (typeof response === 'string') {\n    try {\n        msg.payload = JSON.parse(response);\n    } catch (e) {\n        // Already parsed\n    }\n}\n\nconst event = msg.payload;\n\nif (event.type === 'response.done' && event.response) {\n    const output = event.response.output;\n    if (output && output.length > 0) {\n        const textContent = output.find(o => o.type === 'text');\n        if (textContent && textContent.text) {\n            msg.ai_response = textContent.text;\n            node.warn('ðŸ¤– OpenAI:', textContent.text);\n            return msg;\n        }\n    }\n}\n\nreturn null;",
    "outputs": 1,
    "noerr": 0,
    "x": 450,
    "y": 360,
    "wires": [["send_to_elevenlabs", "execute_gimbal_action"]]
  },
  {
    "id": "send_to_elevenlabs",
    "type": "function",
    "z": "ai_integration_tab",
    "name": "Send to ElevenLabs",
    "func": "const cameraId = flow.get('CAMERA_ID');\nconst lauraUrl = flow.get('LAURA_API_URL');\nconst voiceId = flow.get('ELEVENLABS_VOICE_ID');\n\nconst text = msg.ai_response;\n\nif (!text) {\n    return null;\n}\n\nmsg.url = `${lauraUrl}/api/ai/elevenlabs`;\nmsg.method = 'POST';\nmsg.payload = {\n    text: text,\n    voice_id: voiceId,\n    camera_id: cameraId\n};\n\nnode.warn('ðŸ”Š Generating speech:', text);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 730,
    "y": 360,
    "wires": [["http_tts"]]
  },
  {
    "id": "http_tts",
    "type": "http request",
    "z": "ai_integration_tab",
    "name": "HTTP TTS Request",
    "method": "use",
    "ret": "bin",
    "paytoqs": "ignore",
    "url": "",
    "tls": "",
    "persist": false,
    "proxy": "",
    "authType": "",
    "senderr": false,
    "x": 970,
    "y": 360,
    "wires": [["play_audio"]]
  },
  {
    "id": "play_audio",
    "type": "function",
    "z": "ai_integration_tab",
    "name": "Play Audio on Speaker",
    "func": "// Audio buffer is in msg.payload\nnode.warn('ðŸ”Š Audio received, size:', msg.payload.length, 'bytes');\n\nmsg.filename = '/tmp/tts_response.mp3';\nmsg.play_command = 'aplay /tmp/tts_response.mp3';\n\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 180,
    "y": 460,
    "wires": [["audio_output"]]
  },
  {
    "id": "audio_output",
    "type": "exec",
    "z": "ai_integration_tab",
    "command": "aplay /tmp/tts_response.mp3",
    "addpay": "",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "winHide": false,
    "oldrc": false,
    "name": "Play Audio Exec",
    "x": 430,
    "y": 460,
    "wires": [[], [], []]
  },
  {
    "id": "execute_gimbal_action",
    "type": "function",
    "z": "ai_integration_tab",
    "name": "Parse Gimbal Action",
    "func": "// Parse AI response for gimbal commands\nconst response = msg.ai_response.toLowerCase();\n\nlet gimbalCommand = null;\n\nif (response.includes('look left')) {\n    gimbalCommand = { preset: 'left' };\n} else if (response.includes('look right')) {\n    gimbalCommand = { preset: 'right' };\n} else if (response.includes('look up')) {\n    gimbalCommand = { preset: 'up' };\n} else if (response.includes('look down')) {\n    gimbalCommand = { preset: 'down' };\n} else if (response.includes('center') || response.includes('straight')) {\n    gimbalCommand = { preset: 'center' };\n}\n\nif (gimbalCommand) {\n    msg.gimbal_command = gimbalCommand;\n    node.warn('ðŸŽ® Gimbal command:', gimbalCommand);\n    return msg;\n}\n\nreturn null;",
    "outputs": 1,
    "noerr": 0,
    "x": 740,
    "y": 460,
    "wires": [["send_gimbal_command"]]
  },
  {
    "id": "send_gimbal_command",
    "type": "function",
    "z": "ai_integration_tab",
    "name": "Send to Laura",
    "func": "const cameraUuid = flow.get('CAMERA_UUID');\nconst lauraUrl = flow.get('LAURA_API_URL');\nconst gimbalCmd = msg.gimbal_command;\n\nmsg.url = `${lauraUrl}/api/cameras/${cameraUuid}/command`;\nmsg.method = 'POST';\nmsg.payload = {\n    command_type: 'gimbal_preset',\n    payload: gimbalCmd\n};\n\nnode.warn('ðŸ“¡ Sending gimbal command to Laura');\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 990,
    "y": 460,
    "wires": [["http_gimbal"]]
  },
  {
    "id": "http_gimbal",
    "type": "http request",
    "z": "ai_integration_tab",
    "name": "HTTP Gimbal Command",
    "method": "use",
    "ret": "obj",
    "paytoqs": "ignore",
    "url": "",
    "tls": "",
    "persist": false,
    "proxy": "",
    "authType": "",
    "senderr": false,
    "x": 1220,
    "y": 460,
    "wires": [[]]
  },
  {
    "id": "stream_output",
    "type": "stream",
    "z": "ai_integration_tab",
    "name": "RTSP Stream",
    "protocol": 0,
    "port": 554,
    "session": "live",
    "username": "admin",
    "password": "admin",
    "x": 430,
    "y": 100,
    "wires": []
  },
  {
    "id": "manual_trigger",
    "type": "inject",
    "z": "ai_integration_tab",
    "name": "Test: Ask AI",
    "props": [
      {
        "p": "payload"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "{\"detected_objects\":[{\"class\":\"person\"},{\"class\":\"pizza\"}]}",
    "payloadType": "json",
    "x": 140,
    "y": 560,
    "wires": [["process_detections"]]
  },
  {
    "id": "test_tts",
    "type": "inject",
    "z": "ai_integration_tab",
    "name": "Test: TTS",
    "props": [
      {
        "p": "ai_response",
        "v": "Hello from HeySalad! The kitchen looks great today.",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "x": 530,
    "y": 560,
    "wires": [["send_to_elevenlabs"]]
  },
  {
    "id": "test_gimbal",
    "type": "inject",
    "z": "ai_integration_tab",
    "name": "Test: Gimbal Left",
    "props": [
      {
        "p": "gimbal_command",
        "v": "{\"preset\":\"left\"}",
        "vt": "json"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "x": 780,
    "y": 560,
    "wires": [["send_gimbal_command"]]
  },
  {
    "id": "debug_output",
    "type": "debug",
    "z": "ai_integration_tab",
    "name": "Debug Output",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "true",
    "targetType": "full",
    "statusVal": "",
    "statusType": "auto",
    "x": 660,
    "y": 100,
    "wires": []
  },
  {
    "id": "ai_control_page_ui",
    "type": "ui-template",
    "z": "f7d5cf3810421cf3",
    "group": "ai_assistant_group",
    "page": "",
    "ui": "",
    "name": "AI Assistant Controls",
    "order": 1,
    "width": "12",
    "height": "8",
    "head": "",
    "format": "<template>\n  <div class=\"ai-controls\">\n    <h2>ðŸ¤– HeySalad AI Assistant</h2>\n    \n    <div class=\"status-section\">\n      <h3>Connection Status</h3>\n      <div class=\"status-grid\">\n        <div class=\"status-item\">\n          <span class=\"status-label\">Camera:</span>\n          <span class=\"status-value\" :class=\"cameraStatus\">{{ cameraStatusText }}</span>\n        </div>\n        <div class=\"status-item\">\n          <span class=\"status-label\">OpenAI:</span>\n          <span class=\"status-value\" :class=\"aiStatus\">{{ aiStatusText }}</span>\n        </div>\n        <div class=\"status-item\">\n          <span class=\"status-label\">Gimbal:</span>\n          <span class=\"status-value\" :class=\"gimbalStatus\">{{ gimbalStatusText }}</span>\n        </div>\n      </div>\n    </div>\n\n    <div class=\"control-section\">\n      <h3>Quick Actions</h3>\n      <div class=\"button-grid\">\n        <button @click=\"testAI\" class=\"action-btn\">\n          ðŸ’¬ Test AI Query\n        </button>\n        <button @click=\"testTTS\" class=\"action-btn\">\n          ðŸ”Š Test Speech\n        </button>\n        <button @click=\"gimbalCenter\" class=\"action-btn\">\n          ðŸŽ¯ Center Gimbal\n        </button>\n        <button @click=\"refreshStatus\" class=\"action-btn\">\n          ðŸ”„ Refresh Status\n        </button>\n      </div>\n    </div>\n\n    <div class=\"info-section\">\n      <h3>Configuration</h3>\n      <div class=\"info-grid\">\n        <div class=\"info-item\">\n          <strong>Camera ID:</strong> recamera-gimbal-001\n        </div>\n        <div class=\"info-item\">\n          <strong>Model:</strong> GPT-4o Realtime\n        </div>\n        <div class=\"info-item\">\n          <strong>Voice:</strong> Rachel (ElevenLabs)\n        </div>\n      </div>\n    </div>\n\n    <div class=\"log-section\">\n      <h3>Recent Activity</h3>\n      <div class=\"log-box\">\n        <div v-for=\"(log, index) in logs\" :key=\"index\" class=\"log-entry\">\n          {{ log }}\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\n  export default {\n    data() {\n      return {\n        cameraStatus: 'online',\n        cameraStatusText: 'Online',\n        aiStatus: 'connected',\n        aiStatusText: 'Connected',\n        gimbalStatus: 'ready',\n        gimbalStatusText: 'Ready',\n        logs: [\n          'âœ… AI configuration initialized',\n          'ðŸ“¡ Connected to Laura API',\n          'ðŸ¤– System ready'\n        ]\n      };\n    },\n    methods: {\n      testAI() {\n        this.addLog('ðŸ’¬ Testing AI query...');\n        this.send({ payload: { action: 'test_ai' } });\n      },\n      testTTS() {\n        this.addLog('ðŸ”Š Testing text-to-speech...');\n        this.send({ payload: { action: 'test_tts' } });\n      },\n      gimbalCenter() {\n        this.addLog('ðŸŽ¯ Centering gimbal...');\n        this.send({ payload: { action: 'gimbal_center' } });\n      },\n      refreshStatus() {\n        this.addLog('ðŸ”„ Refreshing status...');\n        this.send({ payload: { action: 'refresh' } });\n      },\n      addLog(message) {\n        const timestamp = new Date().toLocaleTimeString();\n        this.logs.unshift(`[${timestamp}] ${message}`);\n        if (this.logs.length > 10) {\n          this.logs.pop();\n        }\n      }\n    },\n    watch: {\n      msg: function(msg) {\n        if (msg.log) {\n          this.addLog(msg.log);\n        }\n        if (msg.status) {\n          this.cameraStatus = msg.status.camera || this.cameraStatus;\n          this.aiStatus = msg.status.ai || this.aiStatus;\n          this.gimbalStatus = msg.status.gimbal || this.gimbalStatus;\n        }\n      }\n    }\n  };\n</script>\n\n<style scoped>\n  .ai-controls {\n    padding: 20px;\n    font-family: Arial, sans-serif;\n  }\n  \n  h2 {\n    color: #87ba32;\n    margin-bottom: 20px;\n  }\n  \n  h3 {\n    color: #333;\n    margin: 15px 0 10px 0;\n    font-size: 16px;\n  }\n  \n  .status-section, .control-section, .info-section, .log-section {\n    margin-bottom: 25px;\n    padding: 15px;\n    background: #f5f5f5;\n    border-radius: 8px;\n  }\n  \n  .status-grid {\n    display: grid;\n    grid-template-columns: repeat(3, 1fr);\n    gap: 10px;\n  }\n  \n  .status-item {\n    padding: 10px;\n    background: white;\n    border-radius: 6px;\n    text-align: center;\n  }\n  \n  .status-label {\n    display: block;\n    font-size: 12px;\n    color: #666;\n    margin-bottom: 5px;\n  }\n  \n  .status-value {\n    display: block;\n    font-weight: bold;\n    font-size: 14px;\n  }\n  \n  .status-value.online, .status-value.connected, .status-value.ready {\n    color: #87ba32;\n  }\n  \n  .status-value.offline, .status-value.disconnected, .status-value.error {\n    color: #d32f2f;\n  }\n  \n  .button-grid {\n    display: grid;\n    grid-template-columns: repeat(2, 1fr);\n    gap: 10px;\n  }\n  \n  .action-btn {\n    padding: 15px 20px;\n    background: #87ba32;\n    color: white;\n    border: none;\n    border-radius: 6px;\n    cursor: pointer;\n    font-size: 14px;\n    font-weight: bold;\n    transition: background 0.3s;\n  }\n  \n  .action-btn:hover {\n    background: #6a9428;\n  }\n  \n  .info-grid {\n    display: grid;\n    gap: 8px;\n  }\n  \n  .info-item {\n    padding: 8px 12px;\n    background: white;\n    border-radius: 4px;\n    font-size: 13px;\n  }\n  \n  .log-box {\n    background: #1e1e1e;\n    color: #ddd;\n    padding: 12px;\n    border-radius: 6px;\n    max-height: 200px;\n    overflow-y: auto;\n    font-family: 'Courier New', monospace;\n    font-size: 12px;\n  }\n  \n  .log-entry {\n    padding: 4px 0;\n    border-bottom: 1px solid #333;\n  }\n  \n  .log-entry:last-child {\n    border-bottom: none;\n  }\n</style>",
    "storeOutMessages": true,
    "passthru": true,
    "resendOnRefresh": true,
    "templateScope": "local",
    "className": "",
    "x": 620,
    "y": 360,
    "wires": [["ai_action_handler"]]
  },
  {
    "id": "ai_action_handler",
    "type": "function",
    "z": "f7d5cf3810421cf3",
    "name": "Handle AI Actions",
    "func": "const action = msg.payload.action;\n\nif (action === 'test_ai') {\n    return [{ payload: { detected_objects: [{ class: 'person' }, { class: 'pizza' }] } }, null, null];\n} else if (action === 'test_tts') {\n    return [null, { ai_response: 'Hello from HeySalad! The kitchen looks great today.' }, null];\n} else if (action === 'gimbal_center') {\n    return [null, null, { gimbal_command: { preset: 'center' } }];\n} else if (action === 'refresh') {\n    return [null, null, null, { payload: 'refresh' }];\n}\n\nreturn null;",
    "outputs": 4,
    "noerr": 0,
    "x": 870,
    "y": 360,
    "wires": [
      ["process_detections"],
      ["send_to_elevenlabs"],
      ["send_gimbal_command"],
      []
    ]
  },
  {
    "id": "openai_ws_client",
    "type": "websocket-client",
    "path": "wss://heysalad-openai-proxy.heysalad-o.workers.dev/openai-realtime?token=cNf2w6BmZrItVdakHxqUkD7hY/y1swO0NGLBvtI0EXI=",
    "tls": "",
    "wholemsg": "true",
    "hb": "0",
    "subprotocol": ""
  },
  {
    "id": "ai_assistant_group",
    "type": "ui-group",
    "name": "AI Assistant",
    "page": "ai_assistant_page",
    "width": "12",
    "height": "1",
    "order": 1,
    "showTitle": true,
    "className": "",
    "visible": "true",
    "disabled": "false",
    "groupType": "default"
  },
  {
    "id": "ai_assistant_page",
    "type": "ui-page",
    "name": "AI Assistant",
    "ui": "e2f7615831d73e4b",
    "path": "/ai-assistant",
    "icon": "smart_toy",
    "layout": "grid",
    "theme": "f5ee49967f8103a8",
    "breakpoints": [
      {
        "name": "Default",
        "px": "0",
        "cols": "3"
      },
      {
        "name": "Tablet",
        "px": "576",
        "cols": "6"
      },
      {
        "name": "Small Desktop",
        "px": "768",
        "cols": "9"
      },
      {
        "name": "Desktop",
        "px": "1024",
        "cols": "12"
      }
    ],
    "order": 3,
    "className": "",
    "visible": "true",
    "disabled": "false"
  },
  {
    "id": "e2f7615831d73e4b",
    "type": "ui-base",
    "name": "HeySalad Dashboard",
    "path": "/dashboard",
    "includeClientData": true
  },
  {
    "id": "f5ee49967f8103a8",
    "type": "ui-theme",
    "name": "HeySalad Theme",
    "colors": {
      "surface": "#ffffff",
      "primary": "#87ba32",
      "bgPage": "#eeeeee",
      "groupBg": "#ffffff",
      "groupOutline": "#cccccc"
    }
  }
]
